<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>制作案件管理</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'css/base.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.5.0/frappe-gantt.css" />
</head>
<body>
  <header id="header">
    <ul class="h_menu_list">
      {% if request.user.is_authenticated %}
      <li>{{ request.user }}</li>
      <li>
        <form method="post" action="{% url 'logout' %}">
          {% csrf_token %}
          <button type="submit">ログアウト</button>
        </form>
      </li>
      {% else %}
      <li><a href="{% url 'login' %}">ログイン</a></li>
      {% endif %}
      <li><span class="menu_name">案件</span>
        <ul class="sub_menu">
          <li><a href="{% url 'topicks' %}">案件一覧</a></li>
          <li><a href="{% url 'create' %}">新規追加</a></li>
        </ul>
      </li>
      <li><span class="menu_name">デザイナー</span>
        <ul class="sub_menu">
          {% for code, name in designer_choices %}
          <li><a href="{% url 'person_list' person_type='designer' person_name=code %}">{{ name }}</a></li>
          {% endfor %}
        </ul>
      </li>
      <li><span class="menu_name">コーダー</span>
        <ul class="sub_menu">
          {% for code, name in coder_choices %}
          <li><a href="{% url 'person_list' person_type='coder' person_name=code %}">{{ name }}</a></li>
          {% endfor %}
        </ul>
      </li>
    </ul>
  </header>
  <main class="main_cont">
    {% block content %}
    {% endblock content %}
    <div id="gantt"></div>
  </main>
  <footer>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.5.0/frappe-gantt.min.js"></script>
    <script>
document.addEventListener('DOMContentLoaded', function () {
  var tasks = [
    {% for topick in topicks %}
    {
      id: '{{ topick.id }}',
      name: '{{ topick.案件名 }}',
      start: '{{ topick.開始日|date:"Y-m-d" }}',
      end: '{{ topick.終了日|date:"Y-m-d" }}',
      progress: 100,
    },
    {% endfor %}
  ];

  var gantt = new Gantt("#gantt", tasks, {
    view_mode: 'Day',
    on_click: (task) => { console.log(task.name); },
    on_date_change: (task, start, end) => { 
      console.log(`${task.name}: on_date_change ${start} to ${end}`);
      saveDateChange(task.id, start, end); // 日付変更を保存
    },
    on_progress_change: (task, progress) => { console.log(`${task.name}: on_progress_change ${progress}%`); },
    on_view_change: (mode) => { console.log(`View mode changed to ${mode}`); }
  });


  // 日付変更を保存する関数
  function saveDateChange(taskId, start, end) {
    fetch('{% url "update_task_dates" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({
        id: taskId,
        start: start,
        end: end
      })
    }).then(response => {
      if (response.ok) {
        console.log('Date change saved successfully');
      } else {
        console.error('Failed to save date change');
      }
    }).catch(error => {
      console.error('Error:', error);
    });
  }

// ガントチャートが変更されたときに曜日と月を追加
 const dateGroup = document.querySelector('.gantt .date');
    if (dateGroup) {
      //console.log('日付が確認できました');
      addWeekDaysHeader(gantt);
      convertMonthsToJapanese(gantt);
      scrollToToday();
      //obs.disconnect(); // 変更が検出されたら監視を停止
    } else {
      //console.log('日付が確認できません');
    }

  // 月のラベルを日本語に変換する関数
  function convertMonthsToJapanese(gantt) {
    const monthMap = {
      'January': '1月',
      'February': '2月',
      'March': '3月',
      'April': '4月',
      'May': '5月',
      'June': '6月',
      'July': '7月',
      'August': '8月',
      'September': '9月',
      'October': '10月',
      'November': '11月',
      'December': '12月'
    };

    // 月のラベル要素を取得
    var monthLabels = gantt.$svg.querySelectorAll('.date .upper-text');
    monthLabels.forEach((label) => {
      var monthText = label.textContent;
      if (monthMap[monthText]) {
        label.textContent = monthMap[monthText];
      }
    });
  }

// 日付ラベルに対応する曜日を追加する関数
function addWeekDaysHeader(gantt) {
  var dateLabels = gantt.$svg.querySelectorAll('.date .lower-text');
  var currentDate = new Date(); // 現在の日付を基準とする
  currentDate.setHours(0, 0, 0, 0); // 時間をリセットして日付のみを扱う

  dateLabels.forEach((label, index) => {
    var dateText = label.textContent;

    // 基準日からの日数を計算して日付オブジェクトを設定
    var calculatedDate = new Date(currentDate);
    calculatedDate.setDate(currentDate.getDate() + index + 1); // 日数を追加

    var weekDay = calculatedDate.toLocaleDateString('ja-JP', { weekday: 'short' });

    var weekDayLabel = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
    weekDayLabel.setAttribute('dy', 15); // 垂直位置を調整
    weekDayLabel.setAttribute('x', label.getAttribute('x'));
    weekDayLabel.textContent = weekDay;

    label.appendChild(weekDayLabel);
  });
}


// today-highlight要素にスクロールする関数
function scrollToToday() {
  const todayHighlight = document.querySelector('.today-highlight');
  //console.log(todayHighlight);
  if (todayHighlight) {
    const ganttContainer = document.querySelector('.gantt-container');
    const scrollLeft = todayHighlight.getAttribute('x'); // 'x'属性を取得
    //console.log(scrollLeft);
    setTimeout(() => {
      // 初期スクロール位置をリセット
      ganttContainer.scrollLeft = 0;
      // 計算したスクロール位置を設定
      ganttContainer.scrollLeft += parseInt(scrollLeft, 10); // 文字列から整数に変換してスクロール
    }, 100);
  }
}

});

    </script>
  </footer>
</body>
</html>
